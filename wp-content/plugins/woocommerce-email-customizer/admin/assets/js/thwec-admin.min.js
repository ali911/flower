var thwec_base=function($,document){"use strict";function escapeScripts(html){var div=document.createElement("div");div.innerHTML=html;for(var scripts=div.getElementsByTagName("script"),i=scripts.length;i--;)scripts[i].parentNode.removeChild(scripts[i]);return div.innerHTML}return{escapeHTML:function(html){return html.replace(/[&<>"]/g,function(tag){return{'"':"&quot;","'":"&#39;"}[tag]||tag})},decodeHTML:function(html){return html.replace(/'/g,"&#39;").replace(/"/g,"&quot;")},removeHTML:function(html){return html.replace(/[&<>"]/g,"")},isHtmlIdValid:function(id){return/^[a-z\_]+[a-z0-9\_]*$/.test(id.trim())},isCssValid:function(property,value){var div=$("<div>"),_old=div.css(property);return div.css(property,value),_old!=div.css(property)},isValidHexColor:function(value){return!!preg_match("/^#[a-f0-9]{6}$/i",value)},setup_tiptip_tooltips:function(){$(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200})},setupEnhancedMultiSelect:function(parent){parent.find("select.thwec-enhanced-multi-select").each(function(){$(this).hasClass("enhanced")||$(this).select2({minimumResultsForSearch:10,allowClear:!0,placeholder:$(this).data("placeholder")}).addClass("enhanced")})},setupEnhancedMultiSelectWithValue:function(parent){parent.find("select.thwec-enhanced-multi-select").each(function(){var value;$(this).hasClass("enhanced")||($(this).select2({minimumResultsForSearch:10,allowClear:!0,placeholder:$(this).data("placeholder")}).addClass("enhanced"),value=(value=$(this).data("value")).split(","),$(this).val(value),$(this).trigger("change"))})},setupColorPicker:function(form){form.find(".thpladmin-colorpick").iris({change:function(event,ui){var input=$(this);input.parent().find(".thpladmin-colorpickpreview").css({backgroundColor:ui.color.toString()}),input.val(ui.color.toString()),input.trigger("keyup")},hide:!0,border:!0}).click(function(){$(".iris-picker").hide(),$(this).closest("td").find(".iris-picker").show()}),$("body").click(function(){$(".iris-picker").hide()}),$(".thpladmin-colorpick").click(function(event){event.stopPropagation()})},setup_color_pick_preview:function(form){form.find(".thpladmin-colorpick").each(function(){$(this).parent().find(".thpladmin-colorpickpreview").css({backgroundColor:this.value})})},setupSortableTable:function(parent,elm,left){parent.find(elm+" tbody").sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,helper:function(e,ui){return ui.children().each(function(){$(this).width($(this).width())}),ui.css("left",left),ui}}),$(elm+" tbody").on("sortstart",function(event,ui){ui.item.css("background-color","#f6f6f6")}),$(elm+" tbody").on("sortstop",function(event,ui){ui.item.removeAttr("style"),function(elm){$(elm+" tbody tr").each(function(index,el){$("input.f_order",el).val(parseInt($(el).index(elm+" tbody tr")))})}(elm)})},setupPopupTabs:function(form,selector_prefix){$("."+selector_prefix+"-tabs-menu a").click(function(tab){tab.preventDefault(),$(this).parent().addClass("current"),$(this).parent().siblings().removeClass("current");tab=$(this).attr("href");$("."+selector_prefix+"-tab-content").not(tab).css("display","none"),$(tab).fadeIn()})},get_form_field_value:function(field,type){var value="";switch(type){case"select":case"textarea":default:value=null==(value=field.val())?"":value;break;case"checkbox":value=(value=field.prop("checked"))?1:0}return value},get_property_field_value:function(form,type,name){var value="";switch(type){case"select":value=null==(value=form.find("select[name=i_"+name+"]").val())?"":value;break;case"checkbox":value=(value=form.find("input[name=i_"+name+"]").prop("checked"))?1:0;break;case"textarea":value=null==(value=form.find("textarea[name=i_"+name+"]").val())?"":value;break;default:value=null==(value=form.find("input[name=i_"+name+"]").val())?"":value}return value},set_property_field_value:function(form,type,name,value,multiple){var html="textarea_content"==name;switch(type){case"select":1==multiple&&"string"==typeof value&&(value=value.split(","),name+="[]"),form.find('select[name="i_'+name+'"]').val(value);break;case"checkbox":value=1==value,form.find("input[name=i_"+name+"]").prop("checked",value);break;case"textarea":html?form.find("textarea[name=i_"+name+"]").html(value):form.find("textarea[name=i_"+name+"]").val(value);break;default:form.find("input[name=i_"+name+"]").val(value)}},isEmptyArr:function(value){var is_empty=!0;return is_empty=Array.isArray(value)&&value.length?!1:is_empty},isUrlValid:function(url){return/^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(url)},sanitize_html_string:function(html){return function(html){return html.replace(/[&<>"]/g,function(tag){return{'"':"&quot;","'":"&#39;","&":"&amp;","<":"&lt;",">":"&gt;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[tag]||tag})}(escapeScripts(html))},escapeHTMLScripts:escapeScripts}}(window.jQuery,(window,document));function thwecSetupEnhancedMultiSelectWithValue(elm){thwec_base.setupEnhancedMultiSelectWithValue(elm)}function thwecSetupSortableTable(parent,elm,left){thwec_base.setupSortableTable(parent,elm,left)}function thwecSetupPopupTabs(parent,elm,left){thwec_base.setupPopupTabs(parent,elm,left)}function thwecOpenFormTab(elm,tab_id,form_type){thwec_base.openFormTab(elm,tab_id,form_type)}function thwec_setup_color_picker(form){thwec_base.setupColorPicker(form)}jQuery(function($){var PROGRESS_BAR='<div class="thwec-import-uploading-progress">';PROGRESS_BAR+='<img class="thwec-import-type" src="'+thwec_var.admin_plugin_url+'/images/zip.svg">',PROGRESS_BAR+='<div class="thwec-import-progress">',PROGRESS_BAR+='<div class="thwec-import-filename thwec-label">{thwec-upload-file-name}</div>',PROGRESS_BAR+='<div class="thwec-progress-bar meter animate">',PROGRESS_BAR+='<span style="width: 0%"><span></span></span>',PROGRESS_BAR+="</div>",PROGRESS_BAR+='<div class="thwec-import-percentage thwec-label thwec-label-light">Uploading <span>0%</span></div>',PROGRESS_BAR+="</div>",PROGRESS_BAR+='<img class="thwec-import-close" src="'+thwec_var.admin_plugin_url+'/images/close.svg">',PROGRESS_BAR+="</div>";var IMPORTED_FILE="",templateList='<div class="import-modal-footer">';templateList+='<div id="thwec_import_actions_bar">',templateList+="<table>",templateList+="<tr>",templateList+="<td>Copy email subjects</td>",templateList+='<td><input type="checkbox" id="copy_email_subjects" name="copy_email_subjects"><label for="copy_email_subjects">Click to copy email subjects</label></td>',templateList+="</tr>",templateList+="<tr>",templateList+="<td>Copy email mapping</td>",templateList+='<td><input type="checkbox" id="copy_email_mapping" name="copy_email_mapping"><label for="copy_email_mapping">Click to copy email mapping</label></td>',templateList+="</tr>",templateList+="<tr>",templateList+="<td>Replace existing templates</td>",templateList+='<td><input type="checkbox" id="replace_existing_templates"><label for="replace_existing_templates">Click to replace template, if already exists</label></td>',templateList+="</tr>",templateList+="<tr>",templateList+='<td colspan="2" style="text-align:center;"><button id="thwec_import_templates" class="button" type="button">Import</button></td>',templateList+="</tr>",templateList+="</table></div></div>";var UPLOADED_MSG='<div class="thwec-upload-completed">';UPLOADED_MSG+='<img src="'+thwec_var.admin_plugin_url+'/images/upload-completed.svg">',UPLOADED_MSG+='<div class="thwec-sub-heading thwec-label-light thwec-label">Completed</div>',UPLOADED_MSG+="</div>";var UPLOADED='<div class="thwec-uploaded-file thwec-file-meta">';UPLOADED+='<img src="'+thwec_var.admin_plugin_url+'/images/zip.svg">',UPLOADED+='<div class="thwec-label">{thwec-upload-file-name}</div></div>';var templateList={wrapper:$("#thwec_template_list"),init:function(){this.wrapper.on("click",".delete-template",this.confirmTemplateDeletion)},confirmTemplateDeletion:function(){thwec_var.wpml_active&&thwec_var.template_filter?confirm("All created translations of this template will be deleted, if any. Proceed ?")||event.preventDefault():confirm("Do you want to delete this template. This action cannot be undone. Proceed ?")||event.preventDefault()}},mapping={reset_map_button:$("#thwec_reset_mapping"),upload_attachment:$(".thwec-choose-attachment"),remove_attachment:$(".thwec-remove-attachment"),init:function(){this.reset_map_button.click(this.confirmReset),this.upload_attachment.click(this.chooseAttachment),this.remove_attachment.click(this.removeAttachment)},confirmReset:function(event){confirm("Do you want to reset the settings ?")||event.preventDefault()},chooseAttachment:function(event){var target=$(event.target),email_status=target.closest("td").data("email"),frame=wp.media({title:"Email attachment",button:{text:"Set attachment"},multiple:!1});frame.open(),frame.on("select",function(){var uploadHTML=frame.state().get("selection").first().toJSON(),uploadFilePath=mapping.getUploadedFilePath(uploadHTML.url),uploadFileName=uploadHTML.filename,uploadFileSize=uploadHTML.filesizeHumanReadable,uploadHTML='<div class="thwec-uploaded-attachment">';uploadHTML+='<div class="thwec-attachment-meta">',uploadHTML+='<span class="thwec-attachment-title">'+uploadFileName+"</span>",uploadHTML+='<span class="thwec-attachment-size thwec-label-light">'+uploadFileSize+"</span>",uploadHTML+="</div>",uploadHTML+='<img src="'+thwec_var.admin_plugin_url+'/images/delete-attachment.svg" class="thwec-remove-attachment thwec-attachment-remove-icons" />',uploadHTML+='<input type="hidden" name="i_email-attachment-'+email_status+'[]" value="'+uploadFileName+'" />',uploadHTML+='<input type="hidden" name="i_email-attachment-url-'+email_status+'[]" value="'+uploadFilePath+'" />',uploadHTML+='<input type="hidden" name="i_email-attachment-size-'+email_status+'[]" value="'+uploadFileSize+'" />',uploadHTML+="</div>",target.closest(".thwec-attachments-wrapper").find(".thwec-uploaded-attachments").append(uploadHTML),target.closest(".thwec-attachments-wrapper").find(".thwec-attachment-remove-icons").click(mapping.removeAttachment)})},getUploadedFilePath:function(url){return url.replace(thwec_var.upload_folder_info.baseurl,thwec_var.upload_folder_info.basedir)},removeAttachment:function(event){$(event.target).closest(".thwec-uploaded-attachment").remove()}},migrate={wrapper:$(".thwec-template-header"),custom_templates:$(".thwec-custom-templates"),sample_templates:$(".thwec-sample-templates"),export:$("#export_templates"),import:$("#import_templates"),export_panel:$("#export_actions_panel"),export_button:$("#do_export"),import_modal:$("#thwec_import_modal"),choose_file_upload:$("#browse_import_file"),input_file_field:$("#thwec_import_file"),init:function(){this.export.click(this.initiateExport),this.import.click(this.initiateImport),this.export_panel.on("click","#do_export",this.exportTemplate),this.import_modal.on("click",".close-modal",this.closeModal),this.custom_templates.find('input[name="thwec_user_templates[]"').click(this.templateSelected)},initiateExport:function(){var wrapper,export_all_section;migrate.custom_templates.hasClass("export-active")?(migrate.custom_templates.removeClass("export-active"),migrate.export_panel.hide(),migrate.wrapper.find(".thwec-custom-templates-right").hide().html("")):(wrapper=$("#thwec_template_list"),export_all_section=migrate.wrapper.find(".thwec-custom-templates-right"),migrate.custom_templates.addClass("export-active"),migrate.export_panel.show(),0<wrapper.find(".thwec-template-box:not(.thwec-template-add-new)").length&&export_all_section.show(),export_all_section.html('<a class="button thwec-action-buttons thwec-export-all">Select All</a>'),migrate.wrapper.find(".thwec-export-all").click(migrate.selectAllTemplatesToExport))},initiateImport:function(){var export_all_section=migrate.wrapper.find(".thwec-custom-templates-right");export_all_section.is(":visible")&&export_all_section.hide(),migrate.custom_templates.removeClass("export-active"),migrate.export_panel.hide(),migrate.import_modal.show().find(".import-wrapper").addClass("choose-to-upload"),migrate.import_modal.find(".import-wrapper").append($("#import_modal_content").html()),migrate.import_modal.find(".thwec-browse-link").click(migrate.openFileDialog),migrate.import_modal.find('input[name="thwec_import_file"]').change(migrate.uploadSelectedFile)},exportTemplate:function(){var template_ajax_load,data=$("#thwec_template_list"),selectedTemplates=(data.find(".thwec-template-box:not(.thwec-template-add-new)").length,data.find('input[type="checkbox"][name="thwec_user_templates[]"]:checked').map(function(){return this.value}).get()),should_copy_subjects=data.find('input[name="thwec_copy_subjects"]').is(":checked"),data=data.find('input[name="thwec_copy_mapping"]').is(":checked");selectedTemplates.length<1&&!should_copy_subjects&&!data?alert("Choose templates or settings to export"):(template_ajax_load=$("#thwec_ajax_load_modal"),data={templates:selectedTemplates,copy_subjects:should_copy_subjects,copy_mapping:data,action:"thwec_do_export",security:thwec_var.export_nonce},$.ajax({type:"POST",url:thwec_var.ajaxurl,data:data,beforeSend:function(){template_ajax_load.addClass("thwec-ajax-loading"),migrate.export_button.attr("disabled",!0)},success:function(response){template_ajax_load.removeClass("thwec-ajax-loading"),"success"==response.status&&(migrate.export_button.removeAttr("disabled"),window.location=response.url)},error:function(a,b,c){alert("error")}}))},closeModal:function(){migrate.import_modal.find(".import-wrapper").empty(),migrate.import_modal.hide(),migrate.import_modal.removeClass()},closeCompletedModal:function(e){window.location=e.data.location_data,migrate.import_modal.find(".import-contents").children().not(".close-modal").remove(),migrate.import_modal.hide(),migrate.import_modal.removeClass(),migrate.import_modal.find("#thwec_import_actions_bar").remove()},openFileDialog:function(){migrate.import_modal.find('input[name="thwec_import_file"]').click()},uploadSelectedFile:function(import_file){var file,formData,progress_bar_content=PROGRESS_BAR;"zip"!=import_file.target.value.split("\\").pop().split(".").pop()?(alert("Invalid file format"),import_file.target.value=""):(file="",formData=new FormData(migrate.import_modal.find("form")[0]),(import_file=migrate.import_modal.find('input[name="thwec_import_file"]')).length&&(file=import_file[0].files[0],formData.append("file",file)),progress_bar_content=progress_bar_content.replace("{thwec-upload-file-name}",file.name),IMPORTED_FILE=file.name,""==file?alert("Choose settings file to upload"):(migrate.import_modal.find(".thwec-drop-contents").html(progress_bar_content),migrate.startProgressBar(),migrate.importSettings(formData)))},startProgressBar:function(){var form=migrate.import_modal.find("form"),progress_bar=form.find(".thwec-progress-bar > span"),upload_count=form.find(".thwec-import-percentage span"),width=0,id=setInterval(function(){30<=width?clearInterval(id):(width++,progress_bar.width(width+"%"),upload_count.html(width+"%"))},15)},importSettings:function(formData){formData&&(formData.append("action","thwec_do_import"),formData.append("security",thwec_var.import_nonce),formData.append("screen","upload"),$.ajax({type:"POST",url:ajaxurl,data:formData,contentType:!1,processData:!1,success:function(result){var width,progress_bar,upload_count,id;"success"==result.status&&(width=30,progress_bar=migrate.import_modal.find(".thwec-progress-bar > span"),upload_count=migrate.import_modal.find(".thwec-import-percentage span"),id=setInterval(function(){100<=width?(clearInterval(id),migrate.listUploadedItems(result),migrate.import_modal.find("#thwec_import_templates").click(migrate.importSelectedHandler),migrate.import_modal.find(".thwec-import-all").click(migrate.selectAllTemplates),migrate.import_modal.find(".close-modal").click(migrate.closeModal)):(width++,progress_bar.width(width+"%"),upload_count.html(width+"%"))},15))},complete:function(){},error:function(a,b,c){alert("error")}}))},listUploadedItems:function(result){var uploaded_content=UPLOADED;migrate.import_modal.addClass("choose-from-uploaded"),uploaded_content=uploaded_content.replace("{thwec-upload-file-name}",IMPORTED_FILE),migrate.import_modal.find(".thwec-drop-contents").addClass("no-border").html(uploaded_content+UPLOADED_MSG),migrate.import_modal.find('form[name="thwec_template_import_form"]').append(function(result){var templates_in_upload=Object.keys(result.templates).length,list='<div class="imported-templates">';return list+='<div class="thwec-import-templates-list">',list+='<div class="thwec-import-name">'+IMPORTED_FILE,0<templates_in_upload&&(list+='<span class="thwec-import-all">Select all</span>'),list+='</div><div class="thwec-files-to-import">',0<templates_in_upload?$.each(result.templates,function(key,label){list+="<div>",list+='<div class="thwec-image-name"><img src="'+thwec_var.admin_plugin_url+'/images/file.svg">',list+="<span>"+label+"</span></div>",list+='<input type="checkbox" name="thwec_import_template_list[]" value="'+key+'">',list+="</div>"}):list+="<div><span>No templates to import</span></div>",list+="</div>"}(result)),$('<div class="import-modal-footer"><div id="thwec_import_actions_bar"><table><tr><td>Copy email subjects</td><td><input type="checkbox" id="copy_email_subjects" name="copy_email_subjects"><label for="copy_email_subjects">Click to copy email subjects</label></td></tr><tr><td>Copy email mapping</td><td><input type="checkbox" id="copy_email_mapping" name="copy_email_mapping"><label for="copy_email_mapping">Click to copy email mapping</label></td></tr><tr><td>Replace existing templates</td><td><input type="checkbox" id="replace_existing_templates"><label for="replace_existing_templates">Click to replace template, if already exists</label></td></tr><tr><td colspan="2" style="text-align:center;"><button id="thwec_import_templates" class="button" type="button">Import</button></td></tr></table></div></div>').insertAfter(migrate.import_modal.find(".imported-templates"))},importSelectedHandler:function(){var formData=migrate.import_modal.find("form"),copy_subjects=migrate.import_modal.find("#copy_email_subjects").is(":checked"),copy_mapping=migrate.import_modal.find("#copy_email_mapping").is(":checked"),replace_existing=migrate.import_modal.find("#replace_existing_templates").is(":checked"),no_templates=formData.find('input[type="checkbox"][name="thwec_import_template_list[]"]:checked').length<1;replace_existing&&no_templates?alert("Choose templates to export"):no_templates&&!(copy_subjects||copy_mapping||replace_existing)?alert("Choose templates or settings to import "):(formData=new FormData(formData[0]))&&(formData.append("action","thwec_do_import"),formData.append("security",thwec_var.import_nonce),formData.append("screen","import"),formData.append("thwec_copy_subjects",copy_subjects),formData.append("thwec_copy_mapping",copy_mapping),formData.append("thwec_replace_existing",replace_existing),$.ajax({type:"POST",url:ajaxurl,data:formData,contentType:!1,processData:!1,success:function(result){var msg,content;"success"===result.status&&(content=msg="",content="missing"==result.count?(msg="Some templates were not imported. Try again or export them individually.",$("#thwec_import_failed").html()):(msg=result.count+" templates successfully imported.",$("#thwec_import_success").html()),migrate.import_modal.removeClass("choose-from-uploaded"),migrate.import_modal.addClass("import-completed"),migrate.import_modal.find(".thwec-import-upload-file").remove(),migrate.import_modal.find(".imported-templates").remove(),migrate.import_modal.find(".import-modal-footer").remove(),$(content).insertAfter(migrate.import_modal.find(".import-modal-header")),migrate.import_modal.find(".wecm-import-msg").html(msg),migrate.import_modal.find(".close-modal").click({location_data:result.url},migrate.closeCompletedModal))},complete:function(){},error:function(a,b,c){alert("error")}}))},selectAllTemplates:function(){migrate.import_modal.find(".thwec-import-templates-list input:checkbox").prop("checked",!0)},selectAllTemplatesToExport:function(){var button_text="",button_text="Select All"===migrate.wrapper.find(".thwec-export-all").html()?(migrate.custom_templates.find('input[name="thwec_user_templates[]"]').prop("checked",!0),"Clear All"):(migrate.custom_templates.find('input[name="thwec_user_templates[]"]').prop("checked",!1),"Select All");migrate.wrapper.find(".thwec-export-all").html(button_text)},templateSelected:function(){var button=migrate.wrapper.find(".thwec-export-all");migrate.custom_templates.find('input[name="thwec_user_templates[]"]').length===migrate.custom_templates.find('input[type="checkbox"][name="thwec_user_templates[]"]:checked').length?button.html("Clear All"):button.html("Select All")}};migrate.init(),mapping.init(),templateList.init()});